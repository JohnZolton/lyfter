import { type NextPage } from "next";
import Head from "next/head";
import Link from "next/link";
import { api } from "~/utils/api";
import React, {
  useState,
  useTransition,
  useRef,
  useEffect,
  HtmlHTMLAttributes,
} from "react";
import {
  ClerkProvider,
  RedirectToOrganizationProfile,
  RedirectToSignIn,
  useUser,
  SignedIn,
  SignedOut,
  SignInButton,
  UserButton,
} from "@clerk/nextjs";
import { userAgent } from "next/server";
import { userInfo } from "os";
import { boolean, record } from "zod";
import type {
  User,
  Workout,
  WorkoutPlan,
  ActualWorkout,
  ActualExercise,
  exerciseSet,
  WorkoutPlanTwo,
} from "@prisma/client";
import { prisma } from "~/server/db";
import { empty } from "@prisma/client/runtime";
import { SourceTextModule } from "vm";
import { v4 } from "uuid";
import { existsSync } from "fs";
import { create } from "domain";
import { useRouter } from "next/router";
import { describe } from "node:test";
import { TEMPORARY_REDIRECT_STATUS } from "next/dist/shared/lib/constants";
import { faSortNumericDown } from "@fortawesome/free-solid-svg-icons";

const Home: NextPage = () => {
  return (
    <>
      <Head>
        <title>Lyfter</title>
        <meta name="description" content="Generated by create-t3-app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main className="flex min-h-screen flex-col bg-gradient-to-b   from-[#000000]  to-[#44454b]  text-white">
        <nav className="flex items-center justify-between">
          <SignedIn>
            <div className="m-2 flex flex-col text-white ">
              <UserButton
                appearance={{
                  elements: { userButtonAvatarBox: { width: 45, height: 45 } },
                }}
              />
            </div>
          </SignedIn>
          <div className="flex space-x-6 pr-4">
            <Link
              href="home"
              className="text-gray-300 hover:text-white hover:underline"
            >
              Home
            </Link>
            <Link
              href="newplan"
              className="text-gray-300 hover:text-white hover:underline"
            >
              New Plan
            </Link>
            <Link
              href="makeplan"
              className="text-gray-300 hover:text-white hover:underline"
            >
              Edit Plan
            </Link>
            <Link
              href="allworkouts"
              className="text-gray-300 hover:text-white hover:underline"
            >
              History
            </Link>
          </div>
        </nav>
        <div>
          <SignedIn>
            <br></br>
            <Content />
            <br></br>
            <div></div>
          </SignedIn>
          <SignedOut>
            {/* Signed out users get sign in button */}
            <SignInButton redirectUrl="home">
              <button className="rounded-full bg-white p-3 text-xl text-black">
                Sign In
              </button>
            </SignInButton>
          </SignedOut>
        </div>
      </main>
    </>
  );
};

export default Home;

function Content(){
    const user = useUser()
    
    return (
        <div>
            <Workouts/>
        </div>
    )
}

function Workouts() { 
    const { data: workoutPlans, isLoading: workoutsLoading } = api.getWorkouts.getPlanByUserId.useQuery()

    const [selectedPlan, setSelectedPlan ] = useState<WorkoutPlanTwo & {
    workouts: (ActualWorkout & {
        exercises: (ActualExercise & {
            sets: (exerciseSet & {priorSet: exerciseSet | null})[];
        })[];
    })[];
}>()

    if (workoutsLoading) {
        return (
            <div>
              <div
              className="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent align-[-0.125em] text-primary motion-reduce:animate-[spin_1.5s_linear_infinite]"
              role="status">
              <span
                className="!absolute !-m-px !h-px !w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]"
                >Loading...</span
              >
            </div>
            </div>
        )}


    if (!workoutPlans || workoutPlans === undefined){
        return(<div>No Workout History</div>)
    }

    const handleButtonClick = (plan: WorkoutPlanTwo & {
    workouts: (ActualWorkout & {
        exercises: (ActualExercise & {
            sets: (exerciseSet & {priorSet: exerciseSet | null})[];
        })[];
    })[];
}) => {
      setSelectedPlan(plan)
    }

    return (
        <div className="flex flex-wrap">
          <DisplayPlan plan={selectedPlan}/>
              <div>
      { (!selectedPlan) && workoutPlans.map((plan) => (
        <div key={plan.planId}>
          <h2>{plan.description}
          {" "}<button
          onClick={() => handleButtonClick(plan)}
          >Select</button>
          </h2>
        </div>
      ))}
    </div>
        </div>
    )
}

interface DisplayPlanProps {
  plan: WorkoutPlanTwo & {
    workouts: (ActualWorkout & {
        exercises: (ActualExercise & {
            sets: (exerciseSet & {priorSet: exerciseSet | null})[];
        })[];
    })[];
} | undefined;
}

interface SortedWorkouts {
  'Sunday': (ActualWorkout & {
        exercises: (ActualExercise & {
            sets: (exerciseSet & {priorSet: exerciseSet | null})[];
        })[];
    })[];
  'Monday': (ActualWorkout & {
        exercises: (ActualExercise & {
            sets: (exerciseSet & {priorSet: exerciseSet | null})[];
        })[];
    })[];
  'Tuesday': (ActualWorkout & {
        exercises: (ActualExercise & {
            sets: (exerciseSet & {priorSet: exerciseSet| null})[];
        })[];
    })[];
  'Wednesday': (ActualWorkout & {
        exercises: (ActualExercise & {
            sets: (exerciseSet & {priorSet: exerciseSet | null})[];
        })[];
    })[];
  'Thursday': (ActualWorkout & {
        exercises: (ActualExercise & {
            sets: (exerciseSet & {priorSet: exerciseSet | null})[];
        })[];
    })[];
  'Friday': (ActualWorkout & {
        exercises: (ActualExercise & {
            sets: (exerciseSet & {priorSet: exerciseSet | null})[];
        })[];
    })[];
  'Saturday': (ActualWorkout & {
        exercises: (ActualExercise & {
            sets: (exerciseSet & {priorSet: exerciseSet | null})[];
        })[];
    })[];
}

function DisplayPlan({plan}: DisplayPlanProps){
  const [workoutList, setWorkoutList] = useState<SortedWorkouts>()
  if (!plan){
    return(
      <div></div>
    )
  }

  //think i need to manipulate data better before feeding to display, issue is descriptions arent aligning vertically with set data, also what if added exercise during workout?
  function sortWorkoutsByDay(workouts: (ActualWorkout & {
        exercises: (ActualExercise & {
            sets: (exerciseSet & {priorSet: exerciseSet | null})[];
        })[];
    })[]): SortedWorkouts {

    const sortedWorkouts: SortedWorkouts = {
      'Sunday': [],
      'Monday': [],
      'Tuesday': [],
      'Wednesday': [],
      'Thursday': [],
      'Friday': [],
      'Saturday': []
    }
    for (const workout of workouts){
      sortedWorkouts[workout.nominalDay as keyof SortedWorkouts].push(workout)
    }
    return sortedWorkouts
  }

  if (!workoutList){
    setWorkoutList(sortWorkoutsByDay(plan.workouts))
  }
  
  return(

<div className="flex flex-col mx-auto max-w-4xl">
    {workoutList && Object.keys(workoutList).map((day, idx)=> (
            <div key={"base" + idx.toString()}>
          {workoutList[day as keyof typeof workoutList][0]?.description && (
        <div key={day} className="flex flex-col mb-4 bg-slate-800 shadow-md rounded-md p-4">
      <div className="mb-4 text-center text-3xl font-bold">{day}</div>
            <div className="bg-slate-900 overflow-x-auto" style={{maxWidth: '100vw'}}>
                <table className="table-fixed whitespace-nowrap">
                    <thead>
                        <tr>
                            <th className="w-1/4">{workoutList[day as keyof typeof workoutList][0]?.description}
            </th>
                            {workoutList[day as keyof typeof workoutList].map((workout, workoutCount) => (
                                <th className="w-1/4" key={workout.workoutId}>Week {workoutCount+1}</th>
                            ))}
                        </tr>
                    </thead>
                    <tbody>
                        {workoutList[day as keyof typeof workoutList][0]?.exercises.map((exercise, index)=> (
                            <tr key={index}>
                                <td className="border px-4 py-2">{exercise.description}</td>
                                {workoutList[day as keyof typeof workoutList].map((workout) => (
                                    <td className="border px-4 py-2" key={workout.workoutId}>
                                        {workout.exercises[index]?.sets.map((set, setIndex) => (
                                            <div key={set.setId} className={set.priorSet && set.priorSet?.weight > set.weight ||set.priorSet &&  set.priorSet?.reps > set.reps ? 'bg-red-500':''}>
                                                <p>Set {setIndex+1}: {set.weight}lbs x {set.reps} @ {set.rir} RIR</p>
                                            </div>
                                        ))}
                                    </td>
                                ))}
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
          )}
            </div>
    ))}
</div>

  )
}

